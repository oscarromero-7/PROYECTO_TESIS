{% extends "base.html" %}

{% block title %}OptiMon Dashboard - Gestión de Emails{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-envelope"></i> Gestión de Emails
    </h1>

    <div class="row">
        <!-- Agregar Email -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus"></i> Agregar Email</h5>
                </div>
                <div class="card-body">
                    <form id="addEmailForm">
                        <div class="mb-3">
                            <label for="newEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="newEmail" required 
                                   placeholder="usuario@ejemplo.com">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isDefault">
                            <label class="form-check-label" for="isDefault">
                                Establecer como principal
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Email
                        </button>
                    </form>
                </div>
            </div>

            <!-- Información -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Información</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <ul class="mb-0">
                            <li>Los emails se usan para recibir alertas del sistema</li>
                            <li>El email principal es el destinatario por defecto</li>
                            <li>Puedes tener múltiples destinatarios activos</li>
                            <li>Las alertas se envían a todos los emails activos</li>
                        </ul>
                    </small>
                </div>
            </div>
        </div>

        <!-- Lista de Emails -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> Emails Configurados</h5>
                    <button class="btn btn-sm btn-success" onclick="testAllEmails()">
                        <i class="fas fa-paper-plane"></i> Probar Todos
                    </button>
                </div>
                <div class="card-body">
                    <div id="emailsList">
                        <!-- Se carga dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar"></i> Estadísticas</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-primary" id="totalEmails">0</h4>
                                <small>Total Emails</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-success" id="activeEmails">0</h4>
                                <small>Activos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-info" id="lastTest">Nunca</h4>
                                <small>Última Prueba</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let emailsData = [];

// Cargar emails al iniciar la página
document.addEventListener('DOMContentLoaded', function() {
    loadEmails();
});

function loadEmails() {
    fetch('/api/emails')
    .then(response => response.json())
    .then(data => {
        emailsData = data;
        renderEmails();
        updateStats();
    })
    .catch(error => {
        showAlert('Error cargando emails', 'danger');
    });
}

function renderEmails() {
    const container = document.getElementById('emailsList');
    
    if (emailsData.recipients.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-envelope fa-3x mb-3"></i>
                <p>No hay emails configurados</p>
                <p>Agrega tu primer email para recibir alertas</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    emailsData.recipients.forEach((email, index) => {
        const isDefault = email.email === emailsData.default_recipient;
        const badgeClass = email.active ? 'bg-success' : 'bg-secondary';
        const iconClass = isDefault ? 'fas fa-star text-warning' : 'fas fa-envelope text-muted';
        
        html += `
            <div class="card mb-2 ${isDefault ? 'border-warning' : ''}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="${iconClass} me-2"></i>
                                <div>
                                    <strong>${email.email}</strong>
                                    ${isDefault ? '<span class="badge bg-warning ms-2">Principal</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <span class="badge ${badgeClass}">
                                ${email.active ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="btn-group" role="group">
                                ${!isDefault ? `
                                    <button class="btn btn-sm btn-outline-warning" 
                                            onclick="setDefault('${email.email}')"
                                            title="Establecer como principal">
                                        <i class="fas fa-star"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="toggleActive('${email.email}')"
                                        title="${email.active ? 'Desactivar' : 'Activar'}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteEmail('${email.email}')"
                                        title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    ${email.added_date ? `
                        <small class="text-muted">
                            Agregado: ${new Date(email.added_date).toLocaleDateString()}
                        </small>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateStats() {
    document.getElementById('totalEmails').textContent = emailsData.recipients.length;
    document.getElementById('activeEmails').textContent = 
        emailsData.recipients.filter(e => e.active).length;
}

// Agregar email
document.getElementById('addEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('newEmail').value;
    const isDefault = document.getElementById('isDefault').checked;
    
    fetch('/api/emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email: email,
            is_default: isDefault
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert(data.error, 'danger');
        } else {
            showAlert(data.message, 'success');
            document.getElementById('addEmailForm').reset();
            loadEmails();
        }
    })
    .catch(error => {
        showAlert('Error agregando email', 'danger');
    });
});

function deleteEmail(email) {
    if (!confirm(`¿Eliminar el email ${email}?`)) return;
    
    fetch('/api/emails', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message, 'success');
        loadEmails();
    })
    .catch(error => {
        showAlert('Error eliminando email', 'danger');
    });
}

function setDefault(email) {
    // Actualizar en el cliente y guardar
    emailsData.default_recipient = email;
    
    fetch('/api/emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email: email,
            is_default: true
        })
    })
    .then(response => response.json())
    .then(data => {
        showAlert(`${email} establecido como principal`, 'success');
        loadEmails();
    })
    .catch(error => {
        showAlert('Error estableciendo email principal', 'danger');
    });
}

function toggleActive(email) {
    // Encontrar el email y cambiar su estado
    const emailObj = emailsData.recipients.find(e => e.email === email);
    if (emailObj) {
        emailObj.active = !emailObj.active;
        // Aquí deberías hacer una llamada al servidor para guardar el cambio
        showAlert(`Email ${emailObj.active ? 'activado' : 'desactivado'}`, 'info');
        renderEmails();
        updateStats();
    }
}

function testAllEmails() {
    fetch('/api/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            document.getElementById('lastTest').textContent = 'Ahora';
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error enviando emails de prueba', 'danger');
    });
}
</script>
{% endblock %}