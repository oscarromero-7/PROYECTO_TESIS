{% extends "base.html" %}

{% block title %}OptiMon Dashboard - Proveedores Cloud{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-cloud"></i> Proveedores Cloud
    </h1>

    <!-- Tabs de proveedores -->
    <ul class="nav nav-tabs" id="cloudTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="aws-tab" data-bs-toggle="tab" 
                    data-bs-target="#aws" type="button" role="tab">
                <i class="fab fa-aws"></i> AWS
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="azure-tab" data-bs-toggle="tab" 
                    data-bs-target="#azure" type="button" role="tab">
                <i class="fab fa-microsoft"></i> Azure
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gcp-tab" data-bs-toggle="tab" 
                    data-bs-target="#gcp" type="button" role="tab">
                <i class="fab fa-google"></i> Google Cloud
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="local-tab" data-bs-toggle="tab" 
                    data-bs-target="#local" type="button" role="tab">
                <i class="fas fa-server"></i> Servidor Local
            </button>
        </li>
    </ul>

    <div class="tab-content" id="cloudTabsContent">
        
        <!-- AWS Configuration -->
        <div class="tab-pane fade show active" id="aws" role="tabpanel">
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fab fa-aws"></i> Configuración AWS</h5>
                        </div>
                        <div class="card-body">
                            <form id="awsConfigForm">
                                <div class="mb-3">
                                    <label for="awsAccessKey" class="form-label">Access Key ID</label>
                                    <input type="text" class="form-control" id="awsAccessKey" 
                                           placeholder="AKIA...">
                                </div>

                                <div class="mb-3">
                                    <label for="awsSecretKey" class="form-label">Secret Access Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="awsSecretKey" 
                                               placeholder="Clave secreta">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="togglePassword('awsSecretKey')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="awsRegion" class="form-label">Región</label>
                                    <select class="form-control" id="awsRegion">
                                        <option value="us-east-1">US East (N. Virginia)</option>
                                        <option value="us-west-2">US West (Oregon)</option>
                                        <option value="eu-west-1">Europe (Ireland)</option>
                                        <option value="eu-central-1">Europe (Frankfurt)</option>
                                        <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                                        <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
                                        <option value="sa-east-1">South America (São Paulo)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Servicios a Monitorear</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsEC2">
                                                <label class="form-check-label" for="awsEC2">EC2 Instances</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsRDS">
                                                <label class="form-check-label" for="awsRDS">RDS Databases</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsS3">
                                                <label class="form-check-label" for="awsS3">S3 Buckets</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsLB">
                                                <label class="form-check-label" for="awsLB">Load Balancers</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsLambda">
                                                <label class="form-check-label" for="awsLambda">Lambda Functions</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="awsCloudWatch">
                                                <label class="form-check-label" for="awsCloudWatch">CloudWatch</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar Configuración AWS
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="testAwsConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Estado AWS</h6>
                        </div>
                        <div class="card-body">
                            <div id="awsStatus">
                                <div class="row mb-2">
                                    <div class="col-6">Estado:</div>
                                    <div class="col-6"><span class="badge bg-secondary">No configurado</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-question-circle"></i> Configuración AWS</h6>
                        </div>
                        <div class="card-body">
                            <small>
                                <ol>
                                    <li>Ve a la consola de AWS IAM</li>
                                    <li>Crea un nuevo usuario programático</li>
                                    <li>Asigna políticas de CloudWatch y EC2 read-only</li>
                                    <li>Descarga las credenciales Access Key</li>
                                    <li>Ingresa las credenciales aquí</li>
                                </ol>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azure Configuration -->
        <div class="tab-pane fade" id="azure" role="tabpanel">
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fab fa-microsoft"></i> Configuración Azure</h5>
                        </div>
                        <div class="card-body">
                            <form id="azureConfigForm">
                                <div class="mb-3">
                                    <label for="azureSubscriptionId" class="form-label">Subscription ID</label>
                                    <input type="text" class="form-control" id="azureSubscriptionId" 
                                           placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                                </div>

                                <div class="mb-3">
                                    <label for="azureTenantId" class="form-label">Tenant ID</label>
                                    <input type="text" class="form-control" id="azureTenantId" 
                                           placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                                </div>

                                <div class="mb-3">
                                    <label for="azureClientId" class="form-label">Client ID</label>
                                    <input type="text" class="form-control" id="azureClientId" 
                                           placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                                </div>

                                <div class="mb-3">
                                    <label for="azureClientSecret" class="form-label">Client Secret</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="azureClientSecret" 
                                               placeholder="Client Secret">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="togglePassword('azureClientSecret')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Servicios a Monitorear</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureVMs">
                                                <label class="form-check-label" for="azureVMs">Virtual Machines</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureSQL">
                                                <label class="form-check-label" for="azureSQL">SQL Databases</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureStorage">
                                                <label class="form-check-label" for="azureStorage">Storage Accounts</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureAppService">
                                                <label class="form-check-label" for="azureAppService">App Services</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureFunctions">
                                                <label class="form-check-label" for="azureFunctions">Functions</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="azureMonitor">
                                                <label class="form-check-label" for="azureMonitor">Azure Monitor</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar Configuración Azure
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="testAzureConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Estado Azure</h6>
                        </div>
                        <div class="card-body">
                            <div id="azureStatus">
                                <div class="row mb-2">
                                    <div class="col-6">Estado:</div>
                                    <div class="col-6"><span class="badge bg-secondary">No configurado</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-question-circle"></i> Configuración Azure</h6>
                        </div>
                        <div class="card-body">
                            <small>
                                <ol>
                                    <li>Ve al portal de Azure</li>
                                    <li>Registra una aplicación en Azure AD</li>
                                    <li>Asigna permisos de lectura en la suscripción</li>
                                    <li>Crea un client secret</li>
                                    <li>Ingresa las credenciales aquí</li>
                                </ol>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GCP Configuration -->
        <div class="tab-pane fade" id="gcp" role="tabpanel">
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fab fa-google"></i> Configuración Google Cloud</h5>
                        </div>
                        <div class="card-body">
                            <form id="gcpConfigForm">
                                <div class="mb-3">
                                    <label for="gcpProjectId" class="form-label">Project ID</label>
                                    <input type="text" class="form-control" id="gcpProjectId" 
                                           placeholder="mi-proyecto-gcp">
                                </div>

                                <div class="mb-3">
                                    <label for="gcpServiceAccount" class="form-label">Service Account JSON</label>
                                    <textarea class="form-control" id="gcpServiceAccount" rows="6" 
                                              placeholder="Pega aquí el contenido del archivo JSON de la cuenta de servicio"></textarea>
                                    <small class="text-muted">O arrastra el archivo JSON aquí</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Servicios a Monitorear</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpCompute">
                                                <label class="form-check-label" for="gcpCompute">Compute Engine</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpSQL">
                                                <label class="form-check-label" for="gcpSQL">Cloud SQL</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpStorage">
                                                <label class="form-check-label" for="gcpStorage">Cloud Storage</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpFunctions">
                                                <label class="form-check-label" for="gcpFunctions">Cloud Functions</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpGKE">
                                                <label class="form-check-label" for="gcpGKE">GKE Clusters</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="gcpMonitoring">
                                                <label class="form-check-label" for="gcpMonitoring">Cloud Monitoring</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar Configuración GCP
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="testGcpConnection()">
                                        <i class="fas fa-plug"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Estado GCP</h6>
                        </div>
                        <div class="card-body">
                            <div id="gcpStatus">
                                <div class="row mb-2">
                                    <div class="col-6">Estado:</div>
                                    <div class="col-6"><span class="badge bg-secondary">No configurado</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-question-circle"></i> Configuración GCP</h6>
                        </div>
                        <div class="card-body">
                            <small>
                                <ol>
                                    <li>Ve a la consola de GCP</li>
                                    <li>Crea una cuenta de servicio</li>
                                    <li>Asigna roles de Monitoring Viewer</li>
                                    <li>Descarga el archivo JSON de credenciales</li>
                                    <li>Pega el contenido JSON aquí</li>
                                </ol>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Local Server Configuration -->
        <div class="tab-pane fade" id="local" role="tabpanel">
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-server"></i> Servidor Local</h5>
                        </div>
                        <div class="card-body">
                            <form id="localConfigForm">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="enableLocalMonitoring" checked>
                                    <label class="form-check-label" for="enableLocalMonitoring">
                                        <strong>Habilitar monitoreo del servidor local</strong>
                                    </label>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Métricas del Sistema</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localCPU" checked>
                                                <label class="form-check-label" for="localCPU">CPU Usage</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localMemory" checked>
                                                <label class="form-check-label" for="localMemory">Memory Usage</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localDisk" checked>
                                                <label class="form-check-label" for="localDisk">Disk Usage</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localNetwork" checked>
                                                <label class="form-check-label" for="localNetwork">Network I/O</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localProcess" checked>
                                                <label class="form-check-label" for="localProcess">Process Count</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="localUptime" checked>
                                                <label class="form-check-label" for="localUptime">System Uptime</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="localInterval" class="form-label">Intervalo de Recolección</label>
                                    <select class="form-control" id="localInterval">
                                        <option value="15s">15 segundos</option>
                                        <option value="30s" selected>30 segundos</option>
                                        <option value="1m">1 minuto</option>
                                        <option value="5m">5 minutos</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="localPort" class="form-label">Puerto Node Exporter</label>
                                    <input type="number" class="form-control" id="localPort" 
                                           value="9100" placeholder="9100">
                                    <small class="text-muted">Puerto donde ejecutar el exportador de métricas</small>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar Configuración Local
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="installNodeExporter()">
                                        <i class="fas fa-download"></i> Instalar Node Exporter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Estado Local</h6>
                        </div>
                        <div class="card-body">
                            <div id="localStatus">
                                <div class="row mb-2">
                                    <div class="col-6">Node Exporter:</div>
                                    <div class="col-6"><span class="badge bg-secondary" id="nodeExporterStatus">Verificando...</span></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">Puerto:</div>
                                    <div class="col-6" id="nodeExporterPort">9100</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">Métricas:</div>
                                    <div class="col-6" id="metricsCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-chart-line"></i> Métricas Actuales</h6>
                        </div>
                        <div class="card-body">
                            <div id="currentMetrics">
                                <small class="text-muted">Iniciando recolección...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado general de proveedores -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-check"></i> Resumen de Configuración</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <i class="fab fa-aws fa-2x text-primary"></i>
                                    <h6 class="mt-2">AWS</h6>
                                    <span class="badge bg-secondary" id="awsSummaryStatus">No configurado</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <i class="fab fa-microsoft fa-2x text-info"></i>
                                    <h6 class="mt-2">Azure</h6>
                                    <span class="badge bg-secondary" id="azureSummaryStatus">No configurado</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <i class="fab fa-google fa-2x text-warning"></i>
                                    <h6 class="mt-2">Google Cloud</h6>
                                    <span class="badge bg-secondary" id="gcpSummaryStatus">No configurado</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <i class="fas fa-server fa-2x text-success"></i>
                                    <h6 class="mt-2">Local</h6>
                                    <span class="badge bg-success" id="localSummaryStatus">Activo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAllCloudConfigs();
    checkNodeExporterStatus();
    
    // Actualizar estado cada minuto
    setInterval(checkNodeExporterStatus, 60000);
});

function loadAllCloudConfigs() {
    // Cargar configuraciones guardadas de cada proveedor
    loadCloudConfig('aws');
    loadCloudConfig('azure');
    loadCloudConfig('gcp');
    loadCloudConfig('local');
}

function loadCloudConfig(provider) {
    fetch(`/api/cloud/${provider}`)
    .then(response => response.json())
    .then(data => {
        if (data.configured) {
            // Rellenar formulario con datos guardados
            updateCloudStatus(provider, 'configured');
        }
    })
    .catch(error => {
        console.log(`No hay configuración previa para ${provider}`);
    });
}

function updateCloudStatus(provider, status) {
    const statusMap = {
        'configured': { class: 'bg-success', text: 'Configurado' },
        'error': { class: 'bg-danger', text: 'Error' },
        'testing': { class: 'bg-warning', text: 'Probando...' },
        'not_configured': { class: 'bg-secondary', text: 'No configurado' }
    };
    
    const statusInfo = statusMap[status] || statusMap['not_configured'];
    const summaryElement = document.getElementById(`${provider}SummaryStatus`);
    
    if (summaryElement) {
        summaryElement.className = `badge ${statusInfo.class}`;
        summaryElement.textContent = statusInfo.text;
    }
}

// AWS Configuration
document.getElementById('awsConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        access_key: document.getElementById('awsAccessKey').value,
        secret_key: document.getElementById('awsSecretKey').value,
        region: document.getElementById('awsRegion').value,
        services: {
            ec2: document.getElementById('awsEC2').checked,
            rds: document.getElementById('awsRDS').checked,
            s3: document.getElementById('awsS3').checked,
            lb: document.getElementById('awsLB').checked,
            lambda: document.getElementById('awsLambda').checked,
            cloudwatch: document.getElementById('awsCloudWatch').checked
        }
    };
    
    saveCloudConfig('aws', config);
});

// Azure Configuration
document.getElementById('azureConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        subscription_id: document.getElementById('azureSubscriptionId').value,
        tenant_id: document.getElementById('azureTenantId').value,
        client_id: document.getElementById('azureClientId').value,
        client_secret: document.getElementById('azureClientSecret').value,
        services: {
            vms: document.getElementById('azureVMs').checked,
            sql: document.getElementById('azureSQL').checked,
            storage: document.getElementById('azureStorage').checked,
            app_service: document.getElementById('azureAppService').checked,
            functions: document.getElementById('azureFunctions').checked,
            monitor: document.getElementById('azureMonitor').checked
        }
    };
    
    saveCloudConfig('azure', config);
});

// GCP Configuration
document.getElementById('gcpConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        project_id: document.getElementById('gcpProjectId').value,
        service_account: document.getElementById('gcpServiceAccount').value,
        services: {
            compute: document.getElementById('gcpCompute').checked,
            sql: document.getElementById('gcpSQL').checked,
            storage: document.getElementById('gcpStorage').checked,
            functions: document.getElementById('gcpFunctions').checked,
            gke: document.getElementById('gcpGKE').checked,
            monitoring: document.getElementById('gcpMonitoring').checked
        }
    };
    
    saveCloudConfig('gcp', config);
});

// Local Configuration
document.getElementById('localConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        enabled: document.getElementById('enableLocalMonitoring').checked,
        metrics: {
            cpu: document.getElementById('localCPU').checked,
            memory: document.getElementById('localMemory').checked,
            disk: document.getElementById('localDisk').checked,
            network: document.getElementById('localNetwork').checked,
            process: document.getElementById('localProcess').checked,
            uptime: document.getElementById('localUptime').checked
        },
        interval: document.getElementById('localInterval').value,
        port: parseInt(document.getElementById('localPort').value)
    };
    
    saveCloudConfig('local', config);
});

function saveCloudConfig(provider, config) {
    fetch(`/api/cloud/${provider}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert(data.error, 'danger');
            updateCloudStatus(provider, 'error');
        } else {
            showAlert(data.message, 'success');
            updateCloudStatus(provider, 'configured');
        }
    })
    .catch(error => {
        showAlert(`Error guardando configuración ${provider}`, 'danger');
        updateCloudStatus(provider, 'error');
    });
}

function testAwsConnection() {
    updateCloudStatus('aws', 'testing');
    fetch('/api/cloud/aws/test', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            updateCloudStatus('aws', 'configured');
        } else {
            showAlert(data.message, 'danger');
            updateCloudStatus('aws', 'error');
        }
    })
    .catch(error => {
        showAlert('Error probando conexión AWS', 'danger');
        updateCloudStatus('aws', 'error');
    });
}

function testAzureConnection() {
    updateCloudStatus('azure', 'testing');
    fetch('/api/cloud/azure/test', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            updateCloudStatus('azure', 'configured');
        } else {
            showAlert(data.message, 'danger');
            updateCloudStatus('azure', 'error');
        }
    })
    .catch(error => {
        showAlert('Error probando conexión Azure', 'danger');
        updateCloudStatus('azure', 'error');
    });
}

function testGcpConnection() {
    updateCloudStatus('gcp', 'testing');
    fetch('/api/cloud/gcp/test', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            updateCloudStatus('gcp', 'configured');
        } else {
            showAlert(data.message, 'danger');
            updateCloudStatus('gcp', 'error');
        }
    })
    .catch(error => {
        showAlert('Error probando conexión GCP', 'danger');
        updateCloudStatus('gcp', 'error');
    });
}

function checkNodeExporterStatus() {
    fetch('/api/local/node-exporter/status')
    .then(response => response.json())
    .then(data => {
        const statusElement = document.getElementById('nodeExporterStatus');
        if (data.running) {
            statusElement.className = 'badge bg-success';
            statusElement.textContent = 'Activo';
            document.getElementById('metricsCount').textContent = data.metrics_count || 0;
        } else {
            statusElement.className = 'badge bg-danger';
            statusElement.textContent = 'Inactivo';
        }
    })
    .catch(error => {
        document.getElementById('nodeExporterStatus').className = 'badge bg-secondary';
        document.getElementById('nodeExporterStatus').textContent = 'Error';
    });
}

function installNodeExporter() {
    showAlert('Instalando Node Exporter...', 'info');
    
    fetch('/api/local/install-node-exporter', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            checkNodeExporterStatus();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error instalando Node Exporter', 'danger');
    });
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Drag and drop para GCP Service Account JSON
document.getElementById('gcpServiceAccount').addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('border-primary');
});

document.getElementById('gcpServiceAccount').addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('border-primary');
});

document.getElementById('gcpServiceAccount').addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('border-primary');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/json') {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('gcpServiceAccount').value = e.target.result;
            };
            reader.readAsText(file);
        } else {
            showAlert('Por favor arrastra un archivo JSON válido', 'warning');
        }
    }
});
</script>
{% endblock %}