{% extends "base.html" %}

{% block title %}OptiMon Dashboard - Configuración de Monitoreo{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-chart-line"></i> Configuración de Monitoreo
    </h1>

    <div class="row">
        <!-- Configuración de Alertas -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bell"></i> Reglas de Alertas</h5>
                </div>
                <div class="card-body">
                    <form id="alertRulesForm">
                        <div class="mb-3">
                            <label class="form-label">Alertas de CPU</label>
                            <div class="row">
                                <div class="col-8">
                                    <label for="cpuThreshold" class="form-label">Umbral de CPU (%)</label>
                                    <input type="range" class="form-range" id="cpuThreshold" 
                                           min="50" max="95" value="80" 
                                           oninput="updateThresholdValue('cpu', this.value)">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" id="cpuThresholdValue" 
                                           value="80" min="50" max="95"
                                           onchange="updateThresholdRange('cpu', this.value)">
                                </div>
                            </div>
                            <small class="text-muted">Alerta cuando CPU > <span id="cpuThresholdDisplay">80</span>% por 5 minutos</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Alertas de Memoria</label>
                            <div class="row">
                                <div class="col-8">
                                    <label for="memoryThreshold" class="form-label">Umbral de Memoria (%)</label>
                                    <input type="range" class="form-range" id="memoryThreshold" 
                                           min="70" max="95" value="85" 
                                           oninput="updateThresholdValue('memory', this.value)">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" id="memoryThresholdValue" 
                                           value="85" min="70" max="95"
                                           onchange="updateThresholdRange('memory', this.value)">
                                </div>
                            </div>
                            <small class="text-muted">Alerta cuando Memoria > <span id="memoryThresholdDisplay">85</span>% por 3 minutos</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Alertas de Disco</label>
                            <div class="row">
                                <div class="col-8">
                                    <label for="diskThreshold" class="form-label">Umbral de Disco (%)</label>
                                    <input type="range" class="form-range" id="diskThreshold" 
                                           min="80" max="95" value="90" 
                                           oninput="updateThresholdValue('disk', this.value)">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control" id="diskThresholdValue" 
                                           value="90" min="80" max="95"
                                           onchange="updateThresholdRange('disk', this.value)">
                                </div>
                            </div>
                            <small class="text-muted">Alerta cuando Disco > <span id="diskThresholdDisplay">90</span>% por 1 minuto</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Configuración de Tiempo</label>
                            <div class="row">
                                <div class="col-6">
                                    <label for="evaluationInterval" class="form-label">Intervalo de Evaluación</label>
                                    <select class="form-control" id="evaluationInterval">
                                        <option value="15s">15 segundos</option>
                                        <option value="30s" selected>30 segundos</option>
                                        <option value="1m">1 minuto</option>
                                        <option value="5m">5 minutos</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="alertTimeout" class="form-label">Timeout de Alerta</label>
                                    <select class="form-control" id="alertTimeout">
                                        <option value="1m">1 minuto</option>
                                        <option value="5m" selected>5 minutos</option>
                                        <option value="10m">10 minutos</option>
                                        <option value="30m">30 minutos</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Configuración de Alertas
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dashboard Configuration -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-tachometer-alt"></i> Configuración de Dashboard</h6>
                </div>
                <div class="card-body">
                    <form id="dashboardConfigForm">
                        <div class="mb-3">
                            <label for="refreshInterval" class="form-label">Intervalo de Actualización</label>
                            <select class="form-control" id="refreshInterval">
                                <option value="5s">5 segundos</option>
                                <option value="10s">10 segundos</option>
                                <option value="30s" selected>30 segundos</option>
                                <option value="1m">1 minuto</option>
                                <option value="5m">5 minutos</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="dataRetention" class="form-label">Retención de Datos</label>
                            <select class="form-control" id="dataRetention">
                                <option value="1h">1 hora</option>
                                <option value="6h">6 horas</option>
                                <option value="24h" selected>24 horas</option>
                                <option value="7d">7 días</option>
                                <option value="30d">30 días</option>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="enableNotifications" checked>
                            <label class="form-check-label" for="enableNotifications">
                                Habilitar notificaciones del navegador
                            </label>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-save"></i> Guardar Configuración Dashboard
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Estado del Monitoreo -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Estado del Sistema de Monitoreo</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6"><strong>Prometheus:</strong></div>
                        <div class="col-6">
                            <span id="prometheusStatus" class="badge bg-secondary">Verificando...</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6"><strong>Grafana:</strong></div>
                        <div class="col-6">
                            <span id="grafanaStatus" class="badge bg-secondary">Verificando...</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6"><strong>AlertManager:</strong></div>
                        <div class="col-6">
                            <span id="alertmanagerStatus" class="badge bg-secondary">Verificando...</span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6"><strong>Node Exporter:</strong></div>
                        <div class="col-6">
                            <span id="nodeExporterStatus" class="badge bg-secondary">Verificando...</span>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Targets Activos:</strong></div>
                        <div class="col-6" id="activeTargets">0</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Alertas Activas:</strong></div>
                        <div class="col-6" id="activeAlerts">0</div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Última Métrica:</strong></div>
                        <div class="col-6" id="lastMetric">-</div>
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="startMonitoring()">
                            <i class="fas fa-play"></i> Iniciar Monitoreo Completo
                        </button>
                        <button class="btn btn-warning" onclick="restartMonitoring()">
                            <i class="fas fa-redo"></i> Reiniciar Servicios
                        </button>
                        <button class="btn btn-danger" onclick="stopMonitoring()">
                            <i class="fas fa-stop"></i> Detener Monitoreo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Métricas en Tiempo Real -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar"></i> Métricas en Tiempo Real</h6>
                </div>
                <div class="card-body">
                    <div id="realTimeMetrics">
                        <div class="row mb-2">
                            <div class="col-4"><strong>CPU:</strong></div>
                            <div class="col-8">
                                <div class="progress">
                                    <div class="progress-bar" id="cpuProgress" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-4"><strong>Memoria:</strong></div>
                            <div class="col-8">
                                <div class="progress">
                                    <div class="progress-bar bg-info" id="memoryProgress" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-4"><strong>Disco:</strong></div>
                            <div class="col-8">
                                <div class="progress">
                                    <div class="progress-bar bg-warning" id="diskProgress" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <small><strong>Uptime:</strong></div>
                            <div class="col-6">
                                <small id="systemUptime">-</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Activas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-exclamation-triangle"></i> Alertas Activas</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-success" onclick="testAlert()">
                            <i class="fas fa-vial"></i> Probar Alerta
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="silenceAllAlerts()">
                            <i class="fas fa-volume-mute"></i> Silenciar Todas
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="activeAlertsList">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <p>No hay alertas activas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración de Servicios -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Configuración de Servicios</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                    <h6>Prometheus</h6>
                                    <p class="small text-muted">Base de datos de métricas</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="openService('prometheus')">
                                        <i class="fas fa-external-link-alt"></i> Abrir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                    <h6>Grafana</h6>
                                    <p class="small text-muted">Visualización de datos</p>
                                    <button class="btn btn-sm btn-outline-info" onclick="openService('grafana')">
                                        <i class="fas fa-external-link-alt"></i> Abrir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-bell fa-2x text-warning mb-2"></i>
                                    <h6>AlertManager</h6>
                                    <p class="small text-muted">Gestión de alertas</p>
                                    <button class="btn btn-sm btn-outline-warning" onclick="openService('alertmanager')">
                                        <i class="fas fa-external-link-alt"></i> Abrir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-server fa-2x text-success mb-2"></i>
                                    <h6>Node Exporter</h6>
                                    <p class="small text-muted">Exportador de métricas</p>
                                    <button class="btn btn-sm btn-outline-success" onclick="openService('node-exporter')">
                                        <i class="fas fa-external-link-alt"></i> Abrir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let monitoringData = {};

document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringConfig();
    updateMonitoringStatus();
    startRealTimeMetrics();
    loadActiveAlerts();
    
    // Actualizar cada 30 segundos
    setInterval(updateMonitoringStatus, 30000);
    setInterval(loadActiveAlerts, 15000);
});

function updateThresholdValue(type, value) {
    document.getElementById(`${type}ThresholdValue`).value = value;
    document.getElementById(`${type}ThresholdDisplay`).textContent = value;
    document.getElementById(`${type}Threshold`).value = value;
}

function updateThresholdRange(type, value) {
    document.getElementById(`${type}Threshold`).value = value;
    document.getElementById(`${type}ThresholdDisplay`).textContent = value;
}

function loadMonitoringConfig() {
    fetch('/api/monitoring/config')
    .then(response => response.json())
    .then(data => {
        if (data.thresholds) {
            document.getElementById('cpuThreshold').value = data.thresholds.cpu || 80;
            document.getElementById('memoryThreshold').value = data.thresholds.memory || 85;
            document.getElementById('diskThreshold').value = data.thresholds.disk || 90;
            
            updateThresholdValue('cpu', data.thresholds.cpu || 80);
            updateThresholdValue('memory', data.thresholds.memory || 85);
            updateThresholdValue('disk', data.thresholds.disk || 90);
        }
        
        if (data.intervals) {
            document.getElementById('evaluationInterval').value = data.intervals.evaluation || '30s';
            document.getElementById('alertTimeout').value = data.intervals.timeout || '5m';
        }
        
        if (data.dashboard) {
            document.getElementById('refreshInterval').value = data.dashboard.refresh || '30s';
            document.getElementById('dataRetention').value = data.dashboard.retention || '24h';
            document.getElementById('enableNotifications').checked = data.dashboard.notifications !== false;
        }
    })
    .catch(error => {
        console.log('Usando configuración por defecto');
    });
}

function updateMonitoringStatus() {
    fetch('/api/monitoring/status')
    .then(response => response.json())
    .then(data => {
        updateServiceStatus('prometheus', data.prometheus);
        updateServiceStatus('grafana', data.grafana);
        updateServiceStatus('alertmanager', data.alertmanager);
        updateServiceStatus('node-exporter', data.node_exporter);
        
        document.getElementById('activeTargets').textContent = data.targets || 0;
        document.getElementById('activeAlerts').textContent = data.alerts || 0;
        
        if (data.last_metric) {
            document.getElementById('lastMetric').textContent = 
                new Date(data.last_metric).toLocaleTimeString();
        }
    })
    .catch(error => {
        console.log('Error obteniendo estado de monitoreo');
    });
}

function updateServiceStatus(service, status) {
    const element = document.getElementById(`${service}Status`.replace('-', ''));
    if (element) {
        if (status && status.running) {
            element.className = 'badge bg-success';
            element.textContent = 'Activo';
        } else {
            element.className = 'badge bg-danger';
            element.textContent = 'Inactivo';
        }
    }
}

function startRealTimeMetrics() {
    setInterval(() => {
        fetch('/api/monitoring/metrics/current')
        .then(response => response.json())
        .then(data => {
            updateProgressBar('cpu', data.cpu || 0);
            updateProgressBar('memory', data.memory || 0);
            updateProgressBar('disk', data.disk || 0);
            
            if (data.uptime) {
                document.getElementById('systemUptime').textContent = formatUptime(data.uptime);
            }
        })
        .catch(error => {
            console.log('Error obteniendo métricas en tiempo real');
        });
    }, 5000);
}

function updateProgressBar(type, value) {
    const progressBar = document.getElementById(`${type}Progress`);
    const percentage = Math.round(value);
    
    progressBar.style.width = `${percentage}%`;
    progressBar.textContent = `${percentage}%`;
    
    // Cambiar color según el valor
    const thresholds = {
        cpu: 80,
        memory: 85,
        disk: 90
    };
    
    if (percentage >= thresholds[type]) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (percentage >= thresholds[type] - 10) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = type === 'memory' ? 'progress-bar bg-info' : 
                                type === 'disk' ? 'progress-bar bg-warning' : 'progress-bar';
    }
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    return `${days}d ${hours}h ${minutes}m`;
}

function loadActiveAlerts() {
    fetch('/api/monitoring/alerts')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('activeAlertsList');
        
        if (!data.alerts || data.alerts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p>No hay alertas activas</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        data.alerts.forEach(alert => {
            const severity = alert.severity || 'warning';
            const alertClass = severity === 'critical' ? 'danger' : 
                              severity === 'warning' ? 'warning' : 'info';
            
            html += `
                <div class="alert alert-${alertClass} d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${alert.name}</strong>
                        <p class="mb-0">${alert.description}</p>
                        <small class="text-muted">
                            Iniciada: ${new Date(alert.startsAt).toLocaleString()}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="silenceAlert('${alert.fingerprint}')">
                            <i class="fas fa-volume-mute"></i> Silenciar
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    })
    .catch(error => {
        console.log('Error cargando alertas activas');
    });
}

// Guardar configuración de alertas
document.getElementById('alertRulesForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        thresholds: {
            cpu: parseInt(document.getElementById('cpuThresholdValue').value),
            memory: parseInt(document.getElementById('memoryThresholdValue').value),
            disk: parseInt(document.getElementById('diskThresholdValue').value)
        },
        intervals: {
            evaluation: document.getElementById('evaluationInterval').value,
            timeout: document.getElementById('alertTimeout').value
        }
    };
    
    saveMonitoringConfig('alerts', config);
});

// Guardar configuración de dashboard
document.getElementById('dashboardConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        dashboard: {
            refresh: document.getElementById('refreshInterval').value,
            retention: document.getElementById('dataRetention').value,
            notifications: document.getElementById('enableNotifications').checked
        }
    };
    
    saveMonitoringConfig('dashboard', config);
});

function saveMonitoringConfig(type, config) {
    fetch(`/api/monitoring/config/${type}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert(data.error, 'danger');
        } else {
            showAlert(data.message, 'success');
        }
    })
    .catch(error => {
        showAlert(`Error guardando configuración de ${type}`, 'danger');
    });
}

function startMonitoring() {
    showAlert('Iniciando sistema de monitoreo completo...', 'info');
    
    fetch('/api/monitoring/start', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            updateMonitoringStatus();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error iniciando monitoreo', 'danger');
    });
}

function restartMonitoring() {
    showAlert('Reiniciando servicios de monitoreo...', 'info');
    
    fetch('/api/monitoring/restart', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            updateMonitoringStatus();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error reiniciando servicios', 'danger');
    });
}

function stopMonitoring() {
    if (!confirm('¿Detener el sistema de monitoreo?')) return;
    
    fetch('/api/monitoring/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message, data.success ? 'success' : 'danger');
        updateMonitoringStatus();
    })
    .catch(error => {
        showAlert('Error deteniendo monitoreo', 'danger');
    });
}

function testAlert() {
    fetch('/api/monitoring/test-alert', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message, data.success ? 'success' : 'danger');
        loadActiveAlerts();
    })
    .catch(error => {
        showAlert('Error enviando alerta de prueba', 'danger');
    });
}

function silenceAlert(fingerprint) {
    fetch('/api/monitoring/silence-alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fingerprint: fingerprint })
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message, 'info');
        loadActiveAlerts();
    })
    .catch(error => {
        showAlert('Error silenciando alerta', 'danger');
    });
}

function silenceAllAlerts() {
    if (!confirm('¿Silenciar todas las alertas activas?')) return;
    
    fetch('/api/monitoring/silence-all', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message, 'info');
        loadActiveAlerts();
    })
    .catch(error => {
        showAlert('Error silenciando alertas', 'danger');
    });
}

function openService(service) {
    const urls = {
        'prometheus': 'http://localhost:9090',
        'grafana': 'http://localhost:3000',
        'alertmanager': 'http://localhost:9093',
        'node-exporter': 'http://localhost:9100'
    };
    
    if (urls[service]) {
        window.open(urls[service], '_blank');
    }
}
</script>
{% endblock %}